{% extends 'base.html' %} {% block title %}Carrito de compras - Mi Bello Hogar{%
endblock %} {% block css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/carrito.css') }}"
/>
{% endblock %} {% block content %}
<div class="container">
  <h1>Carrito de compras</h1>
  <ul id="cart-items"></ul>
  <p id="total-price">Total: $0</p>
  <a href="#" class="btn-paginapago">Ir a la página de pago</a>
</div>
{% endblock %} {% block js %}
<script src="{{ url_for('static', filename='js/addCart.js') }}"></script>
<script>
  const productos = JSON.parse(localStorage.getItem("carrito"));
  const productImages = {};
  const productQuantities = {};
    const calculateTotal = () => {
    let total = 0;

    for (const product of productos) {
      total += product.precio * (productQuantities[product.id] || 0);
    }

    return total;
  };

  const updateTotal = () => {
    const totalElement = document.getElementById("total-price");
    const total = calculateTotal();
    totalElement.textContent = `Total: $${total}`;
  };

  if (productos.length > 0) {
    const listaProductos = document.getElementById("cart-items");

    for (const product of productos) {
      const productId = product.id;

      if (!productQuantities[productId]) {
        productQuantities[productId] = product.cantidad;
      }

      if (!productImages[productId]) {
        const imageEndpoint = `http://localhost:8000/image/${productId}/principal`;

        fetch(imageEndpoint)
          .then((response) => {
            if (!response.ok) {
              throw new Error("La solicitud de imagen no tuvo éxito.");
            }
            return response.blob();
          })
          .then((blob) => {
            const url = URL.createObjectURL(blob);
            productImages[productId] = url;
            showProductsInCart();
          })
          .catch((error) => {
            console.error("Error al cargar la imagen:", error);
          });
      }
    }

    updateTotal();
  } else {
    const mensaje = document.createElement("p");
    mensaje.textContent = "No hay productos en el carrito.";
    document.getElementById("cart-items").appendChild(mensaje);
  }

  const showProductsInCart = () => {
    const listaProductos = document.getElementById("cart-items");
    listaProductos.innerHTML = ""; // Limpia la lista antes de volver a llenarla
  
    // Crea un objeto para agrupar productos por ID y realizar un seguimiento de la cantidad.
    const groupedProducts = {};
  
    for (const product of productos) {
      const productId = product.id; // Define productId aquí
      if (!groupedProducts[productId]) {
        // Si no existe un grupo para este producto, crea uno.
        groupedProducts[productId] = {
          product: product,
          quantity: 0,
        };
      }
      // Incrementa la cantidad en el grupo.
      groupedProducts[productId].quantity += product.cantidad;
    }
  
    // Itera a través de los grupos de productos y muestra cada grupo en el carrito.
    for (const groupId in groupedProducts) {
      const group = groupedProducts[groupId];
      const product = group.product;
      const quantity = group.quantity;
  
      const item = document.createElement("li");
      item.className = "product-item";
  
      const productImage = document.createElement("img");
  
      // Define productId aquí y pásalo como argumento a la función fetch
      const productId = product.id;
      const imageEndpoint = `http://localhost:8000/image/${productId}/principal`;
  
      fetch(imageEndpoint)
        .then((response) => {
          if (!response.ok) {
            throw new Error("La solicitud de imagen no tuvo éxito.");
          }
          return response.blob();
        })
        .then((blob) => {
          const url = URL.createObjectURL(blob);
          productImage.src = url;
        })
        .catch((error) => {
          console.error("Error al cargar la imagen:", error);
        });
  
      const productInfo = document.createElement("div");
      productInfo.className = "product-info";
      productInfo.innerHTML = `
        <p class="nombre">Nombre: ${product.nombre}</p>
        <p class="precio">Precio: $${product.precio}</p>
        <label>Seleccionar Cantidad:</label>
        <select class="product-quantity" data-product-id="${productId}" onchange="actualizarPrecio(this)">
          ${generateQuantityOptions(quantity)}
        </select>
      `;
  
      const productActions = document.createElement("div");
      productActions.className = "product-actions";
  
      const removeButton = document.createElement("span");
      removeButton.className = "remove-button";
      removeButton.textContent = "X";
      removeButton.onclick = () => {
        removeFromCart(productId);
      };
  
      productActions.appendChild(removeButton);
  
      item.appendChild(productImage);
      item.appendChild(productInfo);
      item.appendChild(productActions);
  
      listaProductos.appendChild(item);
    }
  };
  
  const generateQuantityOptions = (selectedQuantity) => {
    let options = "";
    for (let i = 1; i <= 5; i++) {
      options += `<option value="${i}" ${
        i === selectedQuantity ? "selected" : ""
      }>${i}</option>`;
    }
    return options;
  };

  function removeFromCart(productId) {
    const productIndex = productos.findIndex((product) => product.id === productId);

    if (productIndex !== -1) {
      productos.splice(productIndex, 1);

      // Actualiza el carrito en el almacenamiento local
      localStorage.setItem("carrito", JSON.stringify(productos));
      showProductsInCart();
      updateTotal();
      location.reload()
    }
  }

  function actualizarPrecio(select) {
    const newQuantity = parseInt(select.value, 10);
    const productId = select.getAttribute("data-product-id");
    const product = productos.find((product) => product.id === productId);

    if (product) {
      product.cantidad = newQuantity

      const productIndex = productos.findIndex((prod) => prod.id === productId);
      if (productIndex !== -1) {
        productos[productIndex] = product;
        localStorage.setItem("carrito", JSON.stringify(productos));
      }

      updateTotal();
      location.reload()
    }
  }
</script>
{% endblock js %}
